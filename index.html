<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>MIDI Passthrough (In â†’ Out)</title>
</head>
<body>
  <h2>MIDI Passthrough</h2>

  <label for="inputSelect">Dispositivo de entrada (MIDI In):</label>
  <select id="inputSelect"></select><br><br>

  <label for="outputSelect">Dispositivo de salida (MIDI Out):</label>
  <select id="outputSelect"></select><br><br>

  <p id="status">Inicializando MIDI...</p>

  <script>
    let midiAccess = null;
    let midiInput = null;
    let midiOutput = null;

    async function initMIDI() {
      try {
        midiAccess = await navigator.requestMIDIAccess();
        document.getElementById("status").innerText = "MIDI listo.";
        populateDeviceLists();
        midiAccess.onstatechange = populateDeviceLists;
      } catch (err) {
        document.getElementById("status").innerText = "Error al acceder a MIDI: " + err;
      }
    }

    function populateDeviceLists() {
      const inputSelect = document.getElementById("inputSelect");
      const outputSelect = document.getElementById("outputSelect");

      inputSelect.innerHTML = "";
      outputSelect.innerHTML = "";

      midiAccess.inputs.forEach((input, key) => {
        const option = document.createElement("option");
        option.value = key;
        option.textContent = input.name;
        inputSelect.appendChild(option);
      });

      midiAccess.outputs.forEach((output, key) => {
        const option = document.createElement("option");
        option.value = key;
        option.textContent = output.name;
        outputSelect.appendChild(option);
      });

      inputSelect.onchange = () => {
        if (midiInput) midiInput.onmidimessage = null;
        const selectedId = inputSelect.value;
        midiInput = midiAccess.inputs.get(selectedId);
        if (midiInput) {
          midiInput.onmidimessage = handleMIDIMessage;
        }
      };

      outputSelect.onchange = () => {
        const selectedId = outputSelect.value;
        midiOutput = midiAccess.outputs.get(selectedId);
      };

      // Auto-seleccionar si hay solo uno
      if (inputSelect.options.length === 1) inputSelect.selectedIndex = 0;
      if (outputSelect.options.length === 1) outputSelect.selectedIndex = 0;
      inputSelect.dispatchEvent(new Event("change"));
      outputSelect.dispatchEvent(new Event("change"));
    }

    function handleMIDIMessage(event) {
      if (midiOutput) {
        midiOutput.send(event.data, event.timeStamp);
      }
    }

    initMIDI();
  </script>
</body>
</html>
