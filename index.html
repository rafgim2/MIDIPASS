<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Web MIDI Forwarder</title>
    <style>
      body {
        font-family: system-ui, sans-serif;
        background: #f7f7f7;
        display: grid;
        place-content: center;
        height: 100vh;
        margin: 0;
      }
      .card {
        background: #ffffff;
        border-radius: 1rem;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        padding: 2rem;
        width: min(90vw, 480px);
      }
      h1 {
        font-size: 1.5rem;
        margin-bottom: 1rem;
        text-align: center;
      }
      label {
        display: block;
        margin: 0.75rem 0 0.25rem;
        font-weight: 600;
      }
      select {
        width: 100%;
        padding: 0.5rem;
        border-radius: 0.5rem;
        border: 1px solid #ccc;
        background: #fff;
      }
      /* Hacemos el multi-select un poco más alto para que se vean varias líneas */
      select[multiple] {
        height: 6rem;
      }
      .status {
        margin-top: 1rem;
        text-align: center;
        font-size: 0.9rem;
        color: #555;
      }
    </style>
  </head>
  <body>
    <div class="card">
      <h1>MIDI Forwarder</h1>

      <label for="midiIn">Entrada MIDI</label>
      <select id="midiIn"></select>

      <label for="midiOut">Salidas MIDI (puedes seleccionar varias)</label>
      <select id="midiOut" multiple></select>

      <p class="status" id="status">Conectando a Web MIDI…</p>
    </div>

    <script>
      (function () {
        let midiAccess;
        let selectedIn = null;
        let selectedOuts = [];

        const inSelect = document.getElementById("midiIn");
        const outSelect = document.getElementById("midiOut");
        const statusEl = document.getElementById("status");

        function logStatus(msg) {
          statusEl.textContent = msg;
          console.log(msg);
        }

        function populateSelect(select, items) {
          select.innerHTML = "";
          [...items].forEach((port) => {
            const option = document.createElement("option");
            option.value = port.id;
            option.textContent = `${port.name} (${port.manufacturer || ""})`;
            select.appendChild(option);
          });
        }

        function wireIn(port) {
          // Desconecta listener anterior
          if (selectedIn) {
            selectedIn.onmidimessage = null;
          }
          selectedIn = port;
          if (selectedIn) {
            selectedIn.onmidimessage = (ev) => {
              const ts = window.performance.now();
              if (selectedOuts.length) {
                // Para cada salida seleccionada, reenviamos el mensaje
                selectedOuts.forEach((outPort) => {
                  outPort.send(ev.data, ts);
                });
              }
            };
          }
        }

        function updateSelectedOuts() {
          // Construye un array de puertos de salida según las opciones seleccionadas
          selectedOuts = Array.from(outSelect.selectedOptions)
            .map(opt => midiAccess.outputs.get(opt.value))
            .filter(p => p);
        }

        async function initMIDI() {
          try {
            midiAccess = await navigator.requestMIDIAccess({ sysex: false });
            populateSelect(inSelect, midiAccess.inputs.values());
            populateSelect(outSelect, midiAccess.outputs.values());
            logStatus("Selecciona la entrada y las salidas MIDI.");

            inSelect.addEventListener("change", () => {
              const port = midiAccess.inputs.get(inSelect.value);
              wireIn(port);
              logStatus(`Escuchando en "${port.name}" …`);
            });

            outSelect.addEventListener("change", () => {
              updateSelectedOuts();
              const names = selectedOuts.map(p => p.name).join(' + ');
              logStatus(`Enviando a: ${names}`);
            });

            // Auto‑select primera entrada y primeras salidas si hay
            if (inSelect.options.length) {
              inSelect.selectedIndex = 0;
              wireIn(midiAccess.inputs.get(inSelect.value));
            }
            if (outSelect.options.length) {
              // Seleccionamos todo por defecto
              for (let i = 0; i < outSelect.options.length; i++) {
                outSelect.options[i].selected = true;
              }
              updateSelectedOuts();
            }

            logStatus("Listo: tráfico MIDI reenviado entre dispositivos.");
          } catch (err) {
            logStatus("Web MIDI no está disponible: " + err.message);
          }
        }

        if (navigator.requestMIDIAccess) {
          initMIDI();
        } else {
          logStatus("Tu navegador no soporta la Web MIDI API.");
        }
      })();
    </script>
  </body>
</html>
